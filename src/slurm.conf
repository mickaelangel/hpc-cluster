# =============================================================================
# slurm.conf — Cluster hybride (nœuds CPU + nœuds GPU)
# Référence de production — À adapter (adresses IP, noms, tailles)
# Documentation : Manuel HPC Vol. 4, Guide SLURM, Dictionnaire (Backfill, Fairshare)
# =============================================================================

# -----------------------------------------------------------------------------
# Identification du cluster et contrôleur
# -----------------------------------------------------------------------------
ClusterName=hpc-prod
ControlMachine=login01
ControlAddr=10.0.0.1
SlurmUser=slurm
SlurmctldPort=6817
SlurmdPort=6818

# -----------------------------------------------------------------------------
# Authentification (MUNGE obligatoire en production)
# -----------------------------------------------------------------------------
AuthType=auth/munge
CryptoType=crypto/munge

# -----------------------------------------------------------------------------
# Persistance d'état (HA : partagé entre slurmctld primaire et backup)
# -----------------------------------------------------------------------------
StateSaveLocation=/var/spool/slurm/ctld
SlurmdSpoolDir=/var/spool/slurm/d

# -----------------------------------------------------------------------------
# Suivi des processus : cgroups pour isolation stricte (RAM, CPU, devices)
# Voir Dictionnaire : Cgroups v2 (HPC), OOM-Killer
# -----------------------------------------------------------------------------
ProctrackType=proctrack/cgroup
TaskPlugin=task/cgroup,task/affinity

# -----------------------------------------------------------------------------
# Fichiers PID et politique de retour en service
# -----------------------------------------------------------------------------
SlurmctldPidFile=/var/run/slurmctld.pid
SlurmdPidFile=/var/run/slurmd.pid
ReturnToService=0

# -----------------------------------------------------------------------------
# Réseau / topologie (ex. switch/none si pas de topology plugin)
# -----------------------------------------------------------------------------
SwitchType=switch/none
MpiDefault=none

# -----------------------------------------------------------------------------
# Options contrôleur et démon (configless = les nœuds récupèrent la config)
# -----------------------------------------------------------------------------
SlurmctldParameters=enable_configless
SlurmdParameters=enable_configless,conf_cache

# -----------------------------------------------------------------------------
# Ordonnancement : Backfill + priorité multifactor (Fairshare, âge, etc.)
# Voir Dictionnaire : Backfill Scheduling, Slurm Fairshare
# -----------------------------------------------------------------------------
SchedulerType=sched/backfill
SchedulerParameters=bf_window=1440,bf_resolution=600,bf_max_job_test=500
PriorityType=priority/multifactor
PriorityWeightFairshare=10000
PriorityWeightAge=1000
PriorityWeightPartition=1000
PriorityWeightQOS=1000
PriorityDecayHalfLife=7-0
PriorityUsageResetPeriod=monthly
PriorityFavorSmall=NO
PriorityMaxAge=7-0

# -----------------------------------------------------------------------------
# Limites globales (optionnel)
# -----------------------------------------------------------------------------
JobAcctGatherType=jobacct_gather/cgroup
JobAcctGatherFrequency=30

# -----------------------------------------------------------------------------
# NŒUDS — Adapter les adresses et les ressources réelles
# Format : NodeName=nom NodeAddr=IP CPUs=X RealMemory=Y Gres=... State=UNKNOWN
# RealMemory en Mo. Gres pour les nœuds GPU (voir gres.conf pour le détail).
# -----------------------------------------------------------------------------
# Nœuds de calcul CPU-only (ex. 64 cœurs, 256 Go RAM)
NodeName=compute01 NodeAddr=10.0.1.1 CPUs=64 RealMemory=256000 State=UNKNOWN
NodeName=compute02 NodeAddr=10.0.1.2 CPUs=64 RealMemory=256000 State=UNKNOWN
NodeName=compute03 NodeAddr=10.0.1.3 CPUs=64 RealMemory=256000 State=UNKNOWN
# Nœuds GPU (4× A100 par nœud — détail dans gres.conf)
NodeName=gpu01 NodeAddr=10.0.1.11 CPUs=64 RealMemory=512000 Gres=gpu:a100:4 State=UNKNOWN
NodeName=gpu02 NodeAddr=10.0.1.12 CPUs=64 RealMemory=512000 Gres=gpu:a100:4 State=UNKNOWN

# -----------------------------------------------------------------------------
# PARTITIONS (files d'attente)
# normal  : tous les nœuds CPU, défaut pour les jobs sans GPU
# gpu     : nœuds GPU uniquement, pour --gres=gpu:...
# short   : jobs courts (limite de temps), meilleur backfill
# -----------------------------------------------------------------------------
PartitionName=normal Nodes=compute01,compute02,compute03 Default=YES MaxTime=7-0 State=UP
PartitionName=gpu    Nodes=gpu01,gpu02 MaxTime=3-0 State=UP
PartitionName=short  Nodes=compute01,compute02,compute03 MaxTime=01:00:00 State=UP
